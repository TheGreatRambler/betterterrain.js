/* Copyright 2018 THEGREATRAMBLER https://github.com/TheGreatRambler/betterterrain.js */
(function(d,h){"function"===typeof define&&define.amd?define([],h):"object"===typeof module&&module.exports?module.exports=h():d.betterterrain=h()})("undefined"!==typeof self?self:this,function(){var d={};(function(){function a(a){a||(a=Math.random);this.p=c(a);this.perm=new Uint8Array(512);this.permMod12=new Uint8Array(512);for(a=0;512>a;a++)this.perm[a]=this.p[a&255],this.permMod12[a]=this.perm[a]%12}function c(a){var b,c=new Uint8Array(256);for(b=0;256>b;b++)c[b]=b;for(b=0;255>b;b++){var f=b+~~(a()*
(256-b)),e=c[b];c[b]=c[f];c[f]=e}return c}var b=.5*(Math.sqrt(3)-1),f=(3-Math.sqrt(3))/6,g=1/3,e=1/6,h=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;a.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,
-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(a,c){var e=this.permMod12,d=this.perm,k=this.grad3,v=0,g=0,r=0,l=(a+c)*b,h=Math.floor(a+l),t=Math.floor(c+l);l=(h+t)*f;var m=a-(h-l),n=c-(t-l);if(m>n)var p=1,J=0;else p=0,J=1;var u=m-p+f,A=n-J+f;l=m-1+2*f;var B=n-1+2*f;h&=255;t&=255;var y=.5-m*m-n*n;0<=y&&(v=3*e[h+d[t]],y*=y,v=y*y*(k[v]*m+k[v+1]*n));m=.5-u*u-A*A;0<=m&&(g=3*e[h+p+d[t+J]],m*=m,g=m*m*(k[g]*u+k[g+1]*A));u=.5-l*l-B*B;0<=u&&
(e=3*e[h+1+d[t+1]],u*=u,r=u*u*(k[e]*l+k[e+1]*B));return 70*(v+g+r)},noise3D:function(a,b,c){var f=this.permMod12,d=this.perm,v=this.grad3,k=(a+b+c)*g,l=Math.floor(a+k),h=Math.floor(b+k),r=Math.floor(c+k);k=(l+h+r)*e;var t=a-(l-k),m=b-(h-k),n=c-(r-k),p,q;if(t>=m)if(m>=n)var u=1,A=p=0,B=q=1,y=0;else t>=n?(u=1,A=p=0):(p=u=0,A=1),q=1,B=0,y=1;else m<n?(p=u=0,A=1,q=0,y=B=1):t<n?(u=0,p=1,q=A=0,y=B=1):(u=0,p=1,A=0,B=q=1,y=0);var x=t-u+e,w=m-p+e,z=n-A+e;a=t-q+2*e;var C=m-B+2*e,D=n-y+2*e;c=t-1+3*e;b=m-1+3*
e;k=n-1+3*e;l&=255;h&=255;r&=255;var E=.6-t*t-m*m-n*n;if(0>E)t=0;else{var G=3*f[l+d[h+d[r]]];E*=E;t=E*E*(v[G]*t+v[G+1]*m+v[G+2]*n)}m=.6-x*x-w*w-z*z;0>m?x=0:(u=3*f[l+u+d[h+p+d[r+A]]],m*=m,x=m*m*(v[u]*x+v[u+1]*w+v[u+2]*z));w=.6-a*a-C*C-D*D;0>w?a=0:(q=3*f[l+q+d[h+B+d[r+y]]],w*=w,a=w*w*(v[q]*a+v[q+1]*C+v[q+2]*D));C=.6-c*c-b*b-k*k;0>C?v=0:(f=3*f[l+1+d[h+1+d[r+1]]],C*=C,v=C*C*(v[f]*c+v[f+1]*b+v[f+2]*k));return 32*(t+x+a+v)},noise4D:function(a,b,c,f){var e=this.perm,d=this.grad4,g=(a+b+c+f)*h,k=Math.floor(a+
g),q=Math.floor(b+g),r=Math.floor(c+g),t=Math.floor(f+g);g=(k+q+r+t)*l;var m=a-(k-g),n=b-(q-g),p=c-(r-g),z=f-(t-g);f=c=g=b=0;m>n?b++:g++;m>p?b++:c++;m>z?b++:f++;n>p?g++:c++;n>z?g++:f++;p>z?c++:f++;var u=3<=b?1:0,A=3<=g?1:0,B=3<=c?1:0,y=3<=f?1:0,x=2<=b?1:0,w=2<=g?1:0,F=2<=c?1:0,C=2<=f?1:0;a=1<=b?1:0;var D=1<=g?1:0,E=1<=c?1:0,G=1<=f?1:0,K=m-u+l,L=n-A+l,M=p-B+l,N=z-y+l,O=m-x+2*l,P=n-w+2*l,Q=p-F+2*l,R=z-C+2*l,S=m-a+3*l,T=n-D+3*l,U=p-E+3*l,V=z-G+3*l;f=m-1+4*l;c=n-1+4*l;g=p-1+4*l;b=z-1+4*l;k&=255;q&=255;
r&=255;t&=255;var H=.6-m*m-n*n-p*p-z*z;if(0>H)m=0;else{var I=e[k+e[q+e[r+e[t]]]]%32*4;H*=H;m=H*H*(d[I]*m+d[I+1]*n+d[I+2]*p+d[I+3]*z)}n=.6-K*K-L*L-M*M-N*N;0>n?n=0:(p=e[k+u+e[q+A+e[r+B+e[t+y]]]]%32*4,n*=n,n=n*n*(d[p]*K+d[p+1]*L+d[p+2]*M+d[p+3]*N));p=.6-O*O-P*P-Q*Q-R*R;0>p?x=0:(x=e[k+x+e[q+w+e[r+F+e[t+C]]]]%32*4,p*=p,x=p*p*(d[x]*O+d[x+1]*P+d[x+2]*Q+d[x+3]*R));w=.6-S*S-T*T-U*U-V*V;0>w?a=0:(a=e[k+a+e[q+D+e[r+E+e[t+G]]]]%32*4,w*=w,a=w*w*(d[a]*S+d[a+1]*T+d[a+2]*U+d[a+3]*V));D=.6-f*f-c*c-g*g-b*b;0>D?d=0:
(e=e[k+1+e[q+1+e[r+1+e[t+1]]]]%32*4,D*=D,d=D*D*(d[e]*f+d[e+1]*c+d[e+2]*g+d[e+3]*b));return 27*(m+n+x+a+d)}};a._buildPermutationTable=c;d.rawnoise=a})();(function(){function a(){var a=4022871197;return function(b){b=b.toString();for(var c=0;c<b.length;c++){a+=b.charCodeAt(c);var d=.02519603282416938*a;a=d>>>0;d-=a;d*=a;a=d>>>0;d-=a;a+=4294967296*d}return 2.3283064365386963E-10*(a>>>0)}}d.alea=function(c){var b=this,d=a();b.next=function(){var a=2091639*b.s0+2.3283064365386963E-10*b.c;b.s0=b.s1;b.s1=
b.s2;return b.s2=a-(b.c=a|0)};b.c=1;b.s0=d(" ");b.s1=d(" ");b.s2=d(" ");b.s0-=d(c);0>b.s0&&(b.s0+=1);b.s1-=d(c);0>b.s1&&(b.s1+=1);b.s2-=d(c);0>b.s2&&(b.s2+=1);d=null}})();var h=function(a){"undefined"===typeof a&&(a={});"undefined"===typeof a.seed&&(a.seed=Math.random());"undefined"===typeof a.freq&&(a.freq=50);"undefined"===typeof a.biomes&&(a.biomes={});"undefined"===typeof a.onlyheight&&(a.onlyheight=!1);"undefined"===typeof a.biomemap&&(a.onlyheight=!0);"undefined"===typeof a.initialripple&&(a.initialripple=
1);"undefined"===typeof a.continentmult&&(a.continentmult=2);"undefined"===typeof a.continentfreq&&(a.continentfreq=10);"undefined"===typeof a.moisturefreq&&(a.moisturefreq=2);"undefined"===typeof a.exponent&&(a.exponent=2);"undefined"===typeof a.invert&&(a.invert=!0);"undefined"===typeof a.moistureweight&&(a.moistureweight=1);a.structuresgen="undefined"===typeof a.structures?!1:!0;"undefined"===typeof a.chunksize&&(a.chunksize=32);"undefined"===typeof a.defaultstucturesoverlap&&(a.defaultstucturesoverlap=
!1);"undefined"===typeof a.defaultrequireddistanceseparated&&(a.defaultrequireddistanceseparated=0);"undefined"===typeof a.clearmemoryamount&&(a.clearmemoryamount=5E4);a.createspecialstructs="undefined"===typeof a.specialstructs?!1:!0;this.rng=new d.alea(a.seed);this.terrainnoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.continentnoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.moisturenoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.dataarray=[];this.chunkexists=
[];this.numofelements=0;this.options=a;a.createspecialstructs&&this.createspecialstructs()};d.getindex=function(a,c){var b=0<=a?2*a:-2*a-1,d=0<=c?2*c:-2*c-1;return b>=d?b*b+b+d:d*d+b};d.unpair=function(a){var c=Math.floor(Math.sqrt(a)),b=c*c;a=a-b>=c?[c,a-b-c]:[a-b,c];return[0===a[0]%2?a[0]/2:(a[0]+1)/2*-1,0===a[1]%2?a[1]/2:(a[1]+1)/2*-1]};d.getrandomnumber=function(a,c,b){return Math.floor(b*(c-a+1))+a};h.prototype.getchancefunc=function(a,c,b){var f=0;"undefined"!==typeof b&&(f=b);a=(d.getindex(a,
c)+this.options.seed+f)/1E6;return(new d.alea(a)).next};h.prototype._initxy=function(a,c){"undefined"===typeof this.dataarray[d.getindex(a,c)]&&(this.dataarray[d.getindex(a,c)]={})};h.prototype._reset=function(){this.dataarray.length=0;this.numofelements=this.chunkexists.length=0};h.prototype.createspecialstructs=function(){var a=this;this.options.specialstructs.forEach(function(c){a.getchancefunc(c.x,c.y,3);for(var b="[object Function]"===Object.prototype.toString.call(a.options.structures[c.name].data)?
a.options.structures[c.name].data({x:c.x,y:c.y}):a.options.structures[c.name].data,f=b[0].length,g=b.length,e=0;e<f;e++)for(var h=0;h<g;h++){var l=c.x+e,k=c.y+h;a._initxy(l,k);a.dataarray[d.getindex(l,k)].i=b[h][e];a.dataarray[d.getindex(l,k)].s=c.name}})};h.prototype.generatestructures=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].s){var b=this.options.biomes[this.dataarray[d.getindex(a,c)].b];if("undefined"!==typeof b.structures){var f=this.getchancefunc(a,c,2),g=d.getrandomnumber(0,
b.structures.length-1,f());g=b.structures[g];if(100===g.chance||f()<=g.chance/100*b.structures.length){var e=this.options.structures[g.name];b="[object Function]"===Object.prototype.toString.call(e.data)?e.data({x:a,y:c}):e.data;f=b[0].length;var h=b.length,l=this.getchunkcoordinates(this.getchunkid(a+this.options.chunksize,c+this.options.chunksize));if(a+f<=l[0]&&c+h<=l[1])if("undefined"!==typeof e.allowedoverlap?e.allowedoverlap:this.options.defaultstucturesoverlap)for(e=0;e<f;e++)for(var k=0;k<
h;k++){var r=a+e,q=c+k;this._initxy(r,q);this.dataarray[d.getindex(r,q)].i=b[k][e];this.dataarray[d.getindex(r,q)].s=g.name}else{l=!0;var F="undefined"!==typeof e.requireddistance?e.requireddistance:this.options.defaultrequireddistanceseparated;for(e=0-F;e<f+F;e++)for(k=0-F;k<h+F;k++)if(r=a+e,q=c+k,this.dataarray[d.getindex(r,q)]||this._initxy(r,q),!this.dataarray[d.getindex(r,q)]||this.dataarray[d.getindex(r,q)].i)l=!1;if(l)for(e=0;e<f;e++)for(k=0;k<h;k++)r=a+e,q=c+k,b[k][e]&&(this.dataarray[d.getindex(r,
q)].i=b[k][e]),this.dataarray[d.getindex(r,q)].s=g.name}}}}};h.prototype.generateentities=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].e){var b=this.dataarray[d.getindex(a,c)];if("undefined"!==typeof b.b&&"undefined"!==typeof this.options.biomes[b.b]&&"undefined"!==typeof this.options.biomes[b.b].childentities){var f=this.getchancefunc(a,c,7);b=this.options.biomes[b.b].childentities;for(var g=0;g<b.length;g++){var e=b[g].chance/100;if(f()<=e){this.dataarray[d.getindex(a,c)].e=
b[g].name;break}}}}};h.prototype.generatebiomes=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].b){var b=(this.dataarray[d.getindex(a,c)].m+1)/2;b=1<b||-1>b?1:b;var f=(this.dataarray[d.getindex(a,c)].h+1)/2;b=this.options.biomemap[this.options.biomemap.length-Math.floor(this.options.biomemap.length*(1<f||-1>f?1:f))-1][Math.floor(this.options.biomemap[0].length*b)];if("undefined"!==typeof this.options.biomes[b]&&"undefined"!==typeof this.options.biomes[b].childtiles){f=this.getchancefunc(a,
c,1);for(var g=this.options.biomes[b].childtiles,e=0;e<g.length;e++){var h=g[e].chance/100;if(f()<=h){b=g[e].name;break}}}this.dataarray[d.getindex(a,c)].b=b}};h.prototype.generatemoisture=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].m){var b=this.options.freq,f=this.terrainnoise.noise2D(a/b,c/b),g=.5*this.terrainnoise.noise2D(2*a/b,2*c/b);b=.25*this.terrainnoise.noise2D(4*a/b,4*c/b);f=(f+g+b)*this.options.moistureweight;this.dataarray[d.getindex(a,c)].m=f/this.getprobablemoisture()}};
h.prototype.generateheightmap=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].h){var b=this.options.freq,f=1*this.terrainnoise.noise2D(a/b,c/b),g=.5*this.terrainnoise.noise2D(2*a/b,2*c/b),e=.25*this.terrainnoise.noise2D(4*a/b,4*c/b);f=(f+g+e)*this.options.initialripple;e=b*this.options.continentfreq;b=1*this.continentnoise.noise2D(a/e,c/e);g=.5*this.continentnoise.noise2D(2*a/e,2*c/e);e=.25*this.continentnoise.noise2D(4*a/e,4*c/e);f+=(b+g+e)*this.options.continentmult;f=0<=f?
Math.pow(f,this.options.exponent):0===this.options.exponent%2||0!==this.options.exponent%1?-1*Math.pow(f,this.options.exponent):Math.pow(f,this.options.exponent);this.dataarray[d.getindex(a,c)].h=f/this.getprobableheight()*(this.invert?-1:1)}};h.prototype.getchunkid=function(a,c){return d.getindex(Math.floor(a/this.options.chunksize),Math.floor(c/this.options.chunksize))};h.prototype.chunkexistshere=function(a,c){return this.chunkexists[this.getchunkid(a,c)]?!0:!1};h.prototype.getchunkcoordinates=
function(a){a=d.unpair(a);return[a[0]*this.options.chunksize,a[1]*this.options.chunksize]};h.prototype.getmaxheight=function(){return Math.pow(1.75*this.options.initialripple+1.75*this.options.continentmult,this.options.exponent)};h.prototype.getprobableheight=function(){return(this.options.exponent+1)/(this.options.exponent+2)*Math.pow(1.75*this.options.initialripple+1.75*this.options.continentmult,this.options.exponent)};h.prototype.getprobablemoisture=function(){return 1.75*this.options.moistureweight};
h.prototype.setdata=function(a,c){this._initxy(a,c);this.generateheightmap(a,c);this.options.onlyheight||(this.generatemoisture(a,c),this.generatebiomes(a,c),this.generateentities(a,c),this.options.structuresgen&&this.generatestructures(a,c))};h.prototype.getdata=function(a,c){this.numofelements>this.options.clearmemoryamount&&this._reset();if(!this.chunkexistshere(a,c)){for(var b=this.getchunkcoordinates(this.getchunkid(a,c)),f=0;f<this.options.chunksize;f++)for(var g=0;g<this.options.chunksize;g++)this.setdata(b[0]+
f,b[1]+g),this.numofelements++;this.chunkexists[this.getchunkid(a,c)]=!0}return this.dataarray[d.getindex(a,c)]};return h});
