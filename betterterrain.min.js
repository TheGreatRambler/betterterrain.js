/* Copyright 2018 THEGREATRAMBLER https://github.com/TheGreatRambler/betterterrain.js */
(function(d,g){"function"===typeof define&&define.amd?define([],g):"object"===typeof module&&module.exports?module.exports=g():d.betterterrain=g()})("undefined"!==typeof self?self:this,function(){var d={};(function(){function a(a){a||(a=Math.random);this.p=c(a);this.perm=new Uint8Array(512);this.permMod12=new Uint8Array(512);for(a=0;512>a;a++)this.perm[a]=this.p[a&255],this.permMod12[a]=this.perm[a]%12}function c(a){var b,c=new Uint8Array(256);for(b=0;256>b;b++)c[b]=b;for(b=0;255>b;b++){var f=b+~~(a()*
(256-b)),e=c[b];c[b]=c[f];c[f]=e}return c}var b=.5*(Math.sqrt(3)-1),f=(3-Math.sqrt(3))/6,m=1/3,e=1/6,g=(Math.sqrt(5)-1)/4,h=(5-Math.sqrt(5))/20;a.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,
-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(a,c){var e=this.permMod12,l=this.perm,d=this.grad3,u=0,x=0,m=0,n=(a+c)*b,h=Math.floor(a+n),t=Math.floor(c+n);n=(h+t)*f;var k=a-(h-n),p=c-(t-n);if(k>p)var q=1,K=0;else q=0,K=1;var B=k-q+f,g=p-K+f;n=k-1+2*f;var A=p-1+2*f;h&=255;t&=255;var z=.5-k*k-p*p;0<=z&&(u=3*e[h+l[t]],z*=z,u=z*z*(d[u]*k+d[u+1]*p));k=.5-B*B-g*g;0<=k&&(x=3*e[h+q+l[t+K]],k*=k,x=k*k*(d[x]*B+d[x+1]*g));B=.5-n*n-A*A;0<=B&&
(e=3*e[h+1+l[t+1]],B*=B,m=B*B*(d[e]*n+d[e+1]*A));return 70*(u+x+m)},noise3D:function(a,b,c){var f=this.permMod12,d=this.perm,u=this.grad3,x=(a+b+c)*m,l=Math.floor(a+x),n=Math.floor(b+x),h=Math.floor(c+x);x=(l+n+h)*e;var t=a-(l-x),k=b-(n-x),p=c-(h-x),q,g;if(t>=k)if(k>=p)var r=1,v=q=0,A=g=1,z=0;else t>=p?(r=1,v=q=0):(q=r=0,v=1),g=1,A=0,z=1;else k<p?(q=r=0,v=1,g=0,z=A=1):t<p?(r=0,q=1,g=v=0,z=A=1):(r=0,q=1,v=0,A=g=1,z=0);var y=t-r+e,w=k-q+e,G=p-v+e;a=t-g+2*e;var C=k-A+2*e,D=p-z+2*e;c=t-1+3*e;b=k-1+3*
e;x=p-1+3*e;l&=255;n&=255;h&=255;var E=.6-t*t-k*k-p*p;if(0>E)t=0;else{var H=3*f[l+d[n+d[h]]];E*=E;t=E*E*(u[H]*t+u[H+1]*k+u[H+2]*p)}k=.6-y*y-w*w-G*G;0>k?y=0:(r=3*f[l+r+d[n+q+d[h+v]]],k*=k,y=k*k*(u[r]*y+u[r+1]*w+u[r+2]*G));w=.6-a*a-C*C-D*D;0>w?a=0:(g=3*f[l+g+d[n+A+d[h+z]]],w*=w,a=w*w*(u[g]*a+u[g+1]*C+u[g+2]*D));C=.6-c*c-b*b-x*x;0>C?u=0:(f=3*f[l+1+d[n+1+d[h+1]]],C*=C,u=C*C*(u[f]*c+u[f+1]*b+u[f+2]*x));return 32*(t+y+a+u)},noise4D:function(a,b,c,f){var e=this.perm,d=this.grad4,m=(a+b+c+f)*g,l=Math.floor(a+
m),n=Math.floor(b+m),r=Math.floor(c+m),t=Math.floor(f+m);m=(l+n+r+t)*h;var k=a-(l-m),p=b-(n-m),q=c-(r-m),v=f-(t-m);f=c=m=b=0;k>p?b++:m++;k>q?b++:c++;k>v?b++:f++;p>q?m++:c++;p>v?m++:f++;q>v?c++:f++;var B=3<=b?1:0,F=3<=m?1:0,A=3<=c?1:0,z=3<=f?1:0,y=2<=b?1:0,w=2<=m?1:0,G=2<=c?1:0,C=2<=f?1:0;a=1<=b?1:0;var D=1<=m?1:0,E=1<=c?1:0,H=1<=f?1:0,L=k-B+h,M=p-F+h,N=q-A+h,O=v-z+h,P=k-y+2*h,Q=p-w+2*h,R=q-G+2*h,S=v-C+2*h,T=k-a+3*h,U=p-D+3*h,V=q-E+3*h,W=v-H+3*h;f=k-1+4*h;c=p-1+4*h;m=q-1+4*h;b=v-1+4*h;l&=255;n&=255;
r&=255;t&=255;var I=.6-k*k-p*p-q*q-v*v;if(0>I)k=0;else{var J=e[l+e[n+e[r+e[t]]]]%32*4;I*=I;k=I*I*(d[J]*k+d[J+1]*p+d[J+2]*q+d[J+3]*v)}p=.6-L*L-M*M-N*N-O*O;0>p?p=0:(q=e[l+B+e[n+F+e[r+A+e[t+z]]]]%32*4,p*=p,p=p*p*(d[q]*L+d[q+1]*M+d[q+2]*N+d[q+3]*O));q=.6-P*P-Q*Q-R*R-S*S;0>q?y=0:(y=e[l+y+e[n+w+e[r+G+e[t+C]]]]%32*4,q*=q,y=q*q*(d[y]*P+d[y+1]*Q+d[y+2]*R+d[y+3]*S));w=.6-T*T-U*U-V*V-W*W;0>w?a=0:(a=e[l+a+e[n+D+e[r+E+e[t+H]]]]%32*4,w*=w,a=w*w*(d[a]*T+d[a+1]*U+d[a+2]*V+d[a+3]*W));D=.6-f*f-c*c-m*m-b*b;0>D?d=0:
(e=e[l+1+e[n+1+e[r+1+e[t+1]]]]%32*4,D*=D,d=D*D*(d[e]*f+d[e+1]*c+d[e+2]*m+d[e+3]*b));return 27*(k+p+y+a+d)}};a._buildPermutationTable=c;d.rawnoise=a})();(function(){function a(){var a=4022871197;return function(b){b=b.toString();for(var c=0;c<b.length;c++){a+=b.charCodeAt(c);var d=.02519603282416938*a;a=d>>>0;d-=a;d*=a;a=d>>>0;d-=a;a+=4294967296*d}return 2.3283064365386963E-10*(a>>>0)}}d.alea=function(c){var b=this,d=a();b.next=function(){var a=2091639*b.s0+2.3283064365386963E-10*b.c;b.s0=b.s1;b.s1=
b.s2;return b.s2=a-(b.c=a|0)};b.c=1;b.s0=d(" ");b.s1=d(" ");b.s2=d(" ");b.s0-=d(c);0>b.s0&&(b.s0+=1);b.s1-=d(c);0>b.s1&&(b.s1+=1);b.s2-=d(c);0>b.s2&&(b.s2+=1);d=null}})();var g=function(a){"undefined"===typeof a&&(a={});"undefined"===typeof a.seed&&(a.seed=Math.random());"undefined"===typeof a.freq&&(a.freq=50);"undefined"===typeof a.biomes&&(a.biomes={});"undefined"===typeof a.onlyheight&&(a.onlyheight=!1);"undefined"===typeof a.biomemap&&(a.onlyheight=!0);"undefined"===typeof a.initialripple&&(a.initialripple=
1);"undefined"===typeof a.continentmult&&(a.continentmult=2);"undefined"===typeof a.continentfreq&&(a.continentfreq=10);"undefined"===typeof a.moisturefreq&&(a.moisturefreq=2);"undefined"===typeof a.exponent&&(a.exponent=2);"undefined"===typeof a.invert&&(a.invert=!0);"undefined"===typeof a.moistureweight&&(a.moistureweight=1);a.structuresgen="undefined"===typeof a.structures?!1:!0;"undefined"===typeof a.chunksize&&(a.chunksize=32);"undefined"===typeof a.defaultstucturesoverlap&&(a.defaultstucturesoverlap=
!1);"undefined"===typeof a.defaultrequireddistanceseparated&&(a.defaultrequireddistanceseparated=0);a.createspecialstructs="undefined"===typeof a.specialstructs?!1:!0;this.rng=new d.alea(a.seed);this.terrainnoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.continentnoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.moisturenoise=new d.rawnoise((new d.alea(this.rng.next())).next);this.dataarray=[];this.chunkexists=[];this.visitedriverchunks=[];this.options=a;a.createspecialstructs&&
this.createspecialstructs()};d.getindex=function(a,c){var b=0<=a?2*a:-2*a-1,d=0<=c?2*c:-2*c-1;return b>=d?b*b+b+d:d*d+b};d.unpair=function(a){var c=Math.floor(Math.sqrt(a)),b=c*c;a=a-b>=c?[c,a-b-c]:[a-b,c];return[0===a[0]%2?a[0]/2:(a[0]+1)/2*-1,0===a[1]%2?a[1]/2:(a[1]+1)/2*-1]};d.getrandomnumber=function(a,c,b){return Math.floor(b*(c-a+1))+a};g.prototype.getchancefunc=function(a,c,b){var f=0;"undefined"!==typeof b&&(f=b);a=(d.getindex(a,c)+this.options.seed+f)/1E6;return(new d.alea(a)).next};g.prototype._initxy=
function(a,c){"undefined"===typeof this.dataarray[d.getindex(a,c)]&&(this.dataarray[d.getindex(a,c)]={})};g.prototype.createspecialstructs=function(){var a=this;this.options.specialstructs.forEach(function(c){a.getchancefunc(c.x,c.y,3);for(var b="[object Function]"===Object.prototype.toString.call(a.options.structures[c.name].data)?a.options.structures[c.name].data({x:c.x,y:c.y}):a.options.structures[c.name].data,f=b[0].length,m=b.length,e=0;e<f;e++)for(var g=0;g<m;g++){var h=c.x+e,l=c.y+g;a._initxy(h,
l);a.dataarray[d.getindex(h,l)].i=b[g][e];a.dataarray[d.getindex(h,l)].s=c.name}})};g.prototype.generatestructures=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].s){var b=this.options.biomes[this.dataarray[d.getindex(a,c)].b];if("undefined"!==typeof b.structures){var f=this.getchancefunc(a,c,2),m=d.getrandomnumber(0,b.structures.length-1,f());m=b.structures[m];if(100===m.chance||f()<=m.chance/100*b.structures.length){var e=this.options.structures[m.name];b="[object Function]"===
Object.prototype.toString.call(e.data)?e.data({x:a,y:c}):e.data;f=b[0].length;var g=b.length,h=this.getchunkcoordinates(this.getchunkid(a+this.options.chunksize,c+this.options.chunksize));if(a+f<=h[0]&&c+g<=h[1])if("undefined"!==typeof e.allowedoverlap?e.allowedoverlap:this.options.defaultstucturesoverlap)for(e=0;e<f;e++)for(var l=0;l<g;l++){var n=a+e,r=c+l;this._initxy(n,r);this.dataarray[d.getindex(n,r)].i=b[l][e];this.dataarray[d.getindex(n,r)].s=m.name}else{h=!0;var F="undefined"!==typeof e.requireddistance?
e.requireddistance:this.options.defaultrequireddistanceseparated;for(e=0-F;e<f+F;e++)for(l=0-F;l<g+F;l++)if(n=a+e,r=c+l,this.dataarray[d.getindex(n,r)]||this._initxy(n,r),!this.dataarray[d.getindex(n,r)]||this.dataarray[d.getindex(n,r)].i)h=!1;if(h)for(e=0;e<f;e++)for(l=0;l<g;l++)n=a+e,r=c+l,b[l][e]&&(this.dataarray[d.getindex(n,r)].i=b[l][e]),this.dataarray[d.getindex(n,r)].s=m.name}}}}};g.prototype.generatebiomes=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].b){var b=(this.dataarray[d.getindex(a,
c)].m+1)/2;b=1<b||-1>b?1:b;var f=(this.dataarray[d.getindex(a,c)].h+1)/2;b=this.options.biomemap[this.options.biomemap.length-Math.floor(this.options.biomemap.length*(1<f||-1>f?1:f))-1][Math.floor(this.options.biomemap[0].length*b)];if("undefined"!==typeof this.options.biomes[b]&&"undefined"!==typeof this.options.biomes[b].childtiles){f=this.getchancefunc(a,c,1);for(var m=this.options.biomes[b].childtiles,e=0;e<m.length;e++){var g=m[e].chance/100;if(f()<=g){b=m[e].name;break}}}this.dataarray[d.getindex(a,
c)].b=b}};g.prototype.generatemoisture=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].m){var b=this.terrainnoise.noise2D(a/frequency,c/frequency),f=.5*this.terrainnoise.noise2D(2*a/frequency,2*c/frequency),g=.25*this.terrainnoise.noise2D(4*a/frequency,4*c/frequency);b=(b+f+g)*this.options.moistureweight;this.dataarray[d.getindex(a,c)].m=b/this.getprobablemoisture()}};g.prototype.generateheightmap=function(a,c){if("undefined"===typeof this.dataarray[d.getindex(a,c)].h){var b=
this.options.freq,f=1*this.terrainnoise.noise2D(a/b,c/b),g=.5*this.terrainnoise.noise2D(2*a/b,2*c/b),e=.25*this.terrainnoise.noise2D(4*a/b,4*c/b);f=(f+g+e)*this.options.initialripple;e=b*this.options.continentfreq;b=1*this.continentnoise.noise2D(a/e,c/e);g=.5*this.continentnoise.noise2D(2*a/e,2*c/e);e=.25*this.continentnoise.noise2D(4*a/e,4*c/e);f+=(b+g+e)*this.options.continentmult;f=0<=f?Math.pow(f,this.options.exponent):0===this.options.exponent%2||0!==this.options.exponent%1?-1*Math.pow(f,this.options.exponent):
Math.pow(f,this.options.exponent);this.dataarray[d.getindex(a,c)].h=f/this.getprobableheight()*(this.invert?-1:1)}};g.prototype.getchunkid=function(a,c){return d.getindex(Math.floor(a/this.options.chunksize),Math.floor(c/this.options.chunksize))};g.prototype.chunkexistshere=function(a,c){return this.chunkexists[this.getchunkid(a,c)]?!0:!1};g.prototype.getchunkcoordinates=function(a){a=d.unpair(a);return[a[0]*this.options.chunksize,a[1]*this.options.chunksize]};g.prototype.getmaxheight=function(){return Math.pow(1.75*
this.options.initialripple+1.75*this.options.continentmult,this.options.exponent)};g.prototype.getprobableheight=function(){return(this.options.exponent+1)/(this.options.exponent+2)*Math.pow(1.75*this.options.initialripple+1.75*this.options.continentmult,this.options.exponent)};g.prototype.getprobablemoisture=function(){return 1.75*this.options.moistureweight};g.prototype.setdata=function(a,c){this._initxy(a,c);this.generateheightmap(a,c);this.options.onlyheight||(this.generatemoisture(a,c),this.generatebiomes(a,
c),this.options.structuresgen&&this.generatestructures(a,c))};g.prototype.getdata=function(a,c){if(!this.chunkexistshere(a,c)){for(var b=this.getchunkcoordinates(this.getchunkid(a,c)),f=0;f<this.options.chunksize;f++)for(var g=0;g<this.options.chunksize;g++)this.setdata(b[0]+f,b[1]+g);this.chunkexists[this.getchunkid(a,c)]=!0}return this.dataarray[d.getindex(a,c)]};return g});
